import Foundation
import Testing

@Suite struct PluginSmokeTests {

    #if os(iOS) || os(watchOS) || os(tvOS) || os(visionOS)
    #else
        @Test(
            .disabled(
                if: ProcessInfo.processInfo.environment["__XCODE_BUILT_PRODUCTS_DIR_PATHS"] != nil,
                "\"swift package resolve\" somehow fails to clone git repository only when invoking from Xcode test runner"
            ),
            .disabled(
                if: TestSupport.Configuration.default == nil,
                "WITExtractor tests require a 'Tests/default.json' configuration file"
            )
        )
        func extractPlugin() throws {
            let stdout = try assertSwiftPackage(
                fixturePackage: "PluginSmokePackage",
                ["extract-wit", "--target", "PluginSmokeModule"]
            )
            #expect(
                stdout == """
                    // DO NOT EDIT.
                    //
                    // Generated by the WITExtractor
                    package swift:plugin-smoke-package

                    interface plugin-smoke-module {
                        record struct-A {
                            member-B: s64,
                        }

                        record struct-A-nested-struct-C {
                            member-D: s64,
                        }
                    }
                    """)
        }
    #endif
}
