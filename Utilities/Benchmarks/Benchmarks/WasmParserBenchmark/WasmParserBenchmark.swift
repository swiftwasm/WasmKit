// Benchmark boilerplate generated by Benchmark

import Benchmark
import System
import WasmKit
import _NIOFileSystem

let benchmarks: @Sendable () -> () = {
    Benchmark("WastBenchmark", closure: { (benchmark: Benchmark, setupResult: [(path: String, bytes: [UInt8])]) in
        for _ in benchmark.scaledIterations {
            for (path, bytes) in setupResult {
                blackHole({ () -> Module? in
                    do {
                        let module = try parseWasm(bytes: bytes, features: .all)
                        return module
                    } catch {
                        print("Found error while parsing \(path): \(error)")
                    }
                    return nil
                }())
            }
        }
    }, setup: {
        let packagePath = FilePath(#filePath)
            .removingLastComponent()
            .removingLastComponent()
            .removingLastComponent()
            .removingLastComponent()
            .removingLastComponent()

        let spectestsPath = packagePath
            .appending(["Vendor", "testsuite"])

        let wastOutputPath = packagePath.appending(".build")

        try await FileSystem.shared.withDirectoryHandle(atPath: spectestsPath, options: .init()) { dir in
            for try await entry in dir.listContents(recursive: true) {
                guard entry.path.extension == "wast" else { continue }

                // let result = try await run(
                //     .name("wast2json"),
                //     arguments: [entry.path.string],
                //     workingDirectory: System.FilePath(wastOutputPath.string),
                //     output: .standardError
                // )
                //
                // guard result.terminationStatus.isSuccess else {
                //     continue
                // }
            }
        }
        var wasm = [(path: String, bytes: [UInt8])]()
        try await FileSystem.shared.withDirectoryHandle(atPath: wastOutputPath, options: .init()) { dir in
            for try await entry in dir.listContents(recursive: true) {
                guard entry.path.extension == "wasm" && entry.type == .regular else { continue }

                try await FileSystem.shared.withFileHandle(forReadingAt: entry.path) { file in
                    wasm.append((entry.path.string, .init(buffer: try await file.readToEnd(maximumSizeAllowed: ByteCount.megabytes(1024)))))
                }
            }
        }

        print("Collected \(wasm.count) Wasm files for benchmarking, \(wasm.map(\.bytes.count).reduce(0, +)) bytes in total")
        return wasm
    })
}
